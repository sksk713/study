## 트랜잭션과 락

### 1. 트랜잭션과 격리 수준

### 2. 낙관적 락과 비관적 락 기초

**낙관적 락** 

- 트랜잭션 대부분은 충돌이 발생하지 않는다고 낙관적으로 가정하는 방법
- 데이터베이스가 제공하는 락 기능을 사용하는 것이 아니라 JPA가 제공하는 버전 관리 기능 사용
- 트랜잭션을 커밋하기 전까지는 트랜잭션의 충돌을 알 수 없음

**비관적 락**

- 트랜잭션의 충돌이 발생했다고 가정하고 우선 락을 거는 방법
- 데이터베이스가 제공하는 락 기능을 사용
- 대표적으로 `select for update` 구문이 있음

**두 번의 갱신 분실 문제**

- 동시에 수정할 때 문제 발생
- 문제 해결 방법
  - 마지막 커밋만 인정하기
  - 최초 커밋만 인정하기
  - 충돌하는 갱신 내용 병합하기

### 3. @Version

`@Version` 어노테이션을 사용해서 버전 관리 기능 추가

- 버전 관리 기능을 적용하려면 엔티티에 버전 관리용 필드를 추가
- 엔티티를 수정할 때 마다 버전이 하나씩 자동으로 증가
- 엔티티를 수정할 때 조회 시점의 버전과 수정 시점의 버전이 다르면 예 외 발생
- 최초 커밋만 인정하기 적용

### 4. JPA 락 사용

<aside>
💡 JPA를 사용할 때 추천하는 전략은 READ COMMITTED 트랜잭션 격리 수준 + 낙관적 버전 관리이다.


</aside>

- 락 적용 위치
  - EntityManager.lock(), EntityManager.find(), EntityManager.refresh()
  - Query.setLockMode()
  - @NamedQuery

`JPA가 제공하는 락 옵션 책 참고`

### 5. JPA 낙관적 락

JPA가 제공하는 낙관적 락은 버전(@Version) 사용

낙관적 락은 트랜잭션을 커밋하는 시점에 충돌을 알 수 있음

**락 옵션**

- NONE
  - 락 옵션을 적용하지 않아도 엔티티에 @Version이 적요된 필드만 있으면 낙관적 락이 적용됨
- OPTIMISTIC
  - @Version만 적용했을 때는 엔티티를 수정해야 버전을 체크하지만 이 옵션을 추가하면 엔티티를 조회만 해도 버전을 체크함
  - 한 번 조회한 엔티티는 트랜잭션을 종료할 때까지 다른 트랜잭션에서 변경하지 않음을 보장
- OPTIMISTIC_FORCE_INCREMENT
  - 낙관적 락을 사용하면서 버전 정보를 강제로 증가

### 6. JPA 비관적 락

데이터베이스 트랜잭션 락 메커니즘에 의존하는 방법

- 특징
  - 엔티티가 아닌 스칼라 타입을 조회할 때도 사용 가능
  - 데이터를 수정하는 즉시 트랜잭션 충돌 감지 가능
- 락 옵션
  - PESSIMISTIC_WRITE
    - 일반적인 비관적 락 옵션
    - 데이터베이스에 쓰기 락을 걸 때 사용
  - PESSIMISTIC_READ
    - 데이터를 반복 읽기만 하고 수정하지 않는 용도로 락을 걸 때 사용
    - 잘 사용하지 않음
  - PESSIMISTIC_FORCE_INCREMENT
    - 비관적 락중 유일하게 버전 정보 사용

### 7. 비관적 락과 타임아웃

비관적 락을 사용하면 락을 획득할 때까지 트랜잭션이 대기. 타임아웃 시간 제공 가능

<br>
<br>

## 2차 캐시

### 1. 1차 캐시와 2차 캐시

JPA 구현체들은 애플리케이션 범위의 캐시 지원 이것을 공유 캐시 또는 2차 캐시라 함. 2차 캐시를 적용하면 애플리케이션 조회 성능을 향상할 수 있음

**1차 캐시**

- 1차 캐시는 영속성 컨텍스트 내부에 있음.
- 엔티티 매니저로 조회하거나 변경되는 모든 엔티티는 1차 캐시에 저장됨.
- 트랜잭션을 커밋하거나 플러시를 호출하면 1차 캐시에 있는 엔티티의 변경 내역을 데이터베이스에 동기화
- 특징
  - 1차 캐시는 같은 엔티티가 있으면 해당 엔티티를 그대로 반환한다. 따라서 1차 캐시는 객체 동일성(a==b)를 보장한다.
  - 1차 캐시는 기본적으로 영속성 컨텍스트 범위의 캐시다.

**2차 캐시**

- 애플리케이션에서 공유하는 캐시를 JPA는 공유 캐시라 하는데 일반적으로 2차 캐시라 부른다.
- 2차 캐시는 애플리케이션 범위의 캐시다.
- 특징
  - 2차 캐시는 영속성 유닛 범위의 캐시다.
  - 2차 캐시는 조회한 객체를 그대로 반환하는 것이 아니라 복사본을 만들어서 반환한다.
  - 2차 캐시는 데이터베이스 기본 키를 기준으로 캐시하지만 영속성 컨텍스트가 다르면 객체 동일성(a==b)를 보장하지 않는다.

### 2. JPA 2차 캐시 기능

**캐시 모드 설정**

2차 캐시를 사용하려면 엔티티에 `@Cacheable` 어노테이션 사용

- ShardCacheMode 캐시 모드 설정 옵션 사용해서 설정 범위 지정

### 3. 하이버네이트와 ENCACHE 적용

- 하이버네이트가 지원하느 캐시
  1. 엔티티 캐시 : 엔티티 단위로 캐시
  2. 컬렌션 캐시 : 엔티티와 연관된 컬렉션을 캐시
  3. 쿼리 캐시 : 쿼리와 파라미터 정보를 키로 사용해서 캐시
