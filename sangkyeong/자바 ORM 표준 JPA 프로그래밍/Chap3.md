# JPA란?
자바 진영의 ORM 기술 표준으로 애플리케이션과 JDBC 사이에서 작동한다.
- ORM이란 객체와 관계형 데이터베이스를 매핑한다는 뜻

<br>
ORM 기술을 통해 다양한 패러다임 불일치 문제들을 해결할 수 있으며, JPA의 구현체로는 하이버네이트가 있다.

<br>

# EntityManagerFactory
JPA를 사용할 수 있도록 하는 클래스로 `persistence.xml`의 설정 정보를 읽고 JPA를 동작시키기 위한 객체를 만든다.
- JPA 구현체에 따라서 데이터베이스 커넥션 풀도 생성하여 EMF생성 비용은 매우 크다. -> 애플리케이션 전체에서 한번만 생성해야 한다.

<br>

# EntityManager
EMF에서 EntityManger를 생성하며, JPA의 기능 대부분을 제공하는 클래스다.
- 데이터베이스 커넥션과 밀접한 관계가 있으므로, 스레드간에 공윻하거나 재사용하면 안된다.

***`EMF와 EM 모두 close메소드를 사용해서 종료해주어야 한다.`***<br>
***`JPA를 사용할땐, 항상 트랜잭션 안에서 데이터 변경이 일어나야 한다. EM이 트랜잭션 API를 받아와서 사용한다.`***

<br>

# 영속성 컨텍스트
Entity를 영구 저장하는 환경이라는 뜻으로, EM으로 Entity를 저장하거나 조회하게 되면 `영속성 컨텍스트`에 Entity가 저장되어 EM을 통해 관리할 수 있다.

<br>

# Entity 생명주기
비영속
- Entity 객체를 생성했지만, 아직 EM과 연관된 어떠한 작업도 하지 않은 상태를 말한다.

<br>

영속
- 객체가 영속성 컨텍스트에 저장된 상태 -> EM에 의해 관리되는 상태라고 할 수 있다.
- em.persist()
- find()

<br>

준영속
- 객체가 영속성 컨텍스트에 저장되어 있다가 분리된 상태
- em.detach()
- em.close()
- em.clear()

<br>

삭제
- 객체가 영속성 컨텍스트나 데이터베이스에서 완전 삭제 된 경우
- em.remove()

<br>

# 영속성 컨텍스트의 특징
1. 영속성 컨텍스트에 저장된 객체들을 식별할 수 있는 식별자 값이 반드시 존재해야 한다.
2. 영속성 컨텍스트에 저장된 객체들은 트랜잭션이 커밋되면, DB에 저장된다. -> `flush`

- Entity 조회 <br>
영속성 컨텍스트는 내부에 캐시를 가지는데, 이것을 `1차 캐시`라고 한다. 여기서 key값은 `@Id`로 매핑된 컬럼이 되고, Value는 Entity 인스턴스가 된다.
    - ***`영속성 컨텍스트에 영속된 Entity의 동일성이 보장된다.`***
    - ***`1차 캐시를 통해 Repeatable Read 트랜잭션 격리 수준을 애플리케이션 단에서 제공이 가능해진다.`***

<br>

- Entity 등록 <br>
영속성 컨텍스트는 트랜잭션 커밋 전까지, 내부 쿼리 저장소에 쿼리들을 모아두고 커밋이 되면 데이터베이스로 보낸다. 이것을 `쓰기 지연`이라고 한다.

<br>

- Entity 수정 <br>
`변경 감지(dirty checking) -> 자동으로 수정된 사항을 반영하는 것`<br>
영속성 컨텍스트 1차 캐시에 Entity를 저장할 때, 최초의 상태를 복사해서 저장해두는데 이것을 `스냅샷`이라고 한다. 그 후에 트랜잭션이 커밋되면 `flush()`가 호출 되는데 여기서 스냅샷과 비교해서 변경된 사항이 있는지 찾는다.
 변경사항이 존재하면 내부 쿼리 저장소에 수정 쿼리를 보내고, 그 후에 수정쿼리를 포함한 모든 쿼리를 데이터베이스로 보낸다.
    - ***`변경 감지는 영속성 컨텍스트가 관리하는 영속 상태의 Entity에만 해당한다.`***

<br>

# Flush
`flush`란 영속성 컨텍스트의 변경 내용을 DB에 반영하는 것을 말한다.

flush는 아래 3가지의 경우 발생한다.
1. em.flush() 호출
2. 트랜잭션 커밋 시, 자동 호출
3. JPQL 쿼리 실행 시, 자동 호출

<br>

# 준영속
영속 상태의 Entity가 영속성 컨텍스트에서 분리된 것을 `준영속 상태`라고 한다.

준영속 상태로 가는 3가지 경우
1. em.detach(entity) -> 특정 엔티티만 준영속 상태로 된다.
2. em.clear() -> 영속성 컨텍스트를 완전히 초기화한다.
3. em.close() -> 영속성 컨텍스트를 종료한다.

<br>

준영속 상태를 다시 영속상태로 변경하는 방법
- em.merge(entity)

***`준영속 상태에서는 1차 캐시, 동일성 보장, 쓰기 지연, 변경 감지, 지연 로딩 같은 기능들을 사용할 수 없다`***